function toMiles(a){return 10*Math.round(a/1e3*.621371)/10}function toMeters(a){return 1.6093*parseFloat(a,10)*1e3}var Spinner=function(a,b){a instanceof jQuery?this.$el=a:this.$el=$(a),this.value=b,this.$input=this.$el.find("input"),this.init()};Spinner.prototype.init=function(){return this.set(this.value),this.$el.find(".up").click(function(a){a.preventDefault(),this.increase()}.bind(this)),this.$el.find(".down").click(function(a){a.preventDefault(),this.decrease()}.bind(this)),this.$el.on("keyup keypress",function(a){var b=a.keyCode||a.which;13==b&&(a.preventDefault(),this.set(this.$input.val()),this.$el.trigger("spinner.manualSet",this.value))}.bind(this)),this},Spinner.prototype.updateView=function(a){return this.$input.val(a),this},Spinner.prototype.set=function(a){return this.value=a,this.updateView(a),this},Spinner.prototype.increase=function(){return this.value++,this.updateView(this.value),this.$el.trigger("spinner.increased",this.value),this},Spinner.prototype.decrease=function(){return this.value-1<=0?this:(this.value--,this.updateView(this.value),this.$el.trigger("spinner.decreased",this.value),this)};var map,Map=function(a){a instanceof jQuery?(this.$el=a,this.el=this.$el[0]):(this.el=a,this.$el=$(a)),this.init()};Map.prototype.init=function(){return this.setup=!0,this.fields={},this.properties={},this.$class=$(".form-location"),this.fields.$lat=$("#id_group_form-latitude"),this.fields.$lng=$("#id_group_form-longitude"),this.fields.$rad=$("#id_group_form-radius"),this.fields.$checkbox=$("#location_toggle"),this.spinner=new Spinner(".spinner",25),this.fields.$address=$("#id_group_form-address"),this.fields.$display=$("#id_group_form-display_location"),this.properties.rad=this.fields.$rad.val(),this.circle,this.properties.isNew=isNew,this.properties.hasLocation=this.properties.isNew||""!=this.fields.$lat.val(),this.properties.hasLocation&&(this.properties.latLng=new google.maps.LatLng(this.fields.$lat.val(),this.fields.$lng.val())),this.map=new google.maps.Map(this.$el[0],{zoom:8,mapTypeId:google.maps.MapTypeId.ROADMAP}),this.toggleSetup(),this.setInitialLocation(),this.$el.on("propChange",function(){this.render()}.bind(this)),this.$el.on("propReset",function(){this.updateFields()}.bind(this)),this},Map.prototype.render=function(){return this.placeMarker(),this.updateFields(),this.setup&&this.events(),this},Map.prototype.events=function(){return google.maps.event.addListener(this.map,"click",function(a){this.setProperties({latLng:a.latLng}),ga("send","event","Map Action","Map clicked",a.latLng)}.bind(this)),this.fields.$address.click(function(){$(this).val("")}).submit(function(a){a.preventDefault(),$(".address .btn").click()}).on("keyup keypress",function(a){var b=a.keyCode||a.which;13==b&&(a.preventDefault(),$(".address .btn").click())}),$(".address .btn").click(function(){ga("send","event","Map Action","Address button submitted",this.fields.$address.val()),this.setProperties({address:this.fields.$address.val()})}.bind(this)),this.spinner.$el.on("spinner.increased spinner.decreased spinner.manualSet",function(a,b){ga("send","event","Map Action","Radius changed via spinner",b),this.setProperties({rad:toMeters(b)})}.bind(this)),this.setup=!1,this},Map.prototype.setProperties=function(a){var b=$.Deferred();return a.latLng&&("reset"!=a.latLng?(this.properties.latLng=a.latLng,$.when(this.geocode({latLng:a.latLng})).then(function(a){this.properties.address=a[0].formatted_address,this.properties.display_loc=a[1].formatted_address.replace(/, USA/,""),b.done(this.$el.trigger("propChange")),b.resolve()}.bind(this))):(this.properties.latLng="",this.$el.trigger("propReset"))),a.rad&&("reset"!=a.rad?(this.properties.rad=a.rad,this.$el.trigger("propChange")):(this.properties.rad="",this.$el.trigger("propReset"))),a.address&&("reset"!=a.rad?(this.properties.address=a.address,this.properties.display_loc=a.address,$.when(this.geocode({address:a.address})).then(function(a){this.properties.latLng=a[0].geometry.location,b.done(this.$el.trigger("propChange")),b.resolve()}.bind(this))):(this.properties.address="",this.properties.display_loc="")),ga("send","event","Map Action","Map updated",this.properties.address),this},Map.prototype.toggleSetup=function(){this.fields.$checkbox.change(function(a){this.fields.$checkbox.is(":checked")?(this.$class.show(),this.properties.hasLocation=!0,this.setInitialLocation()):this.reset()}.bind(this))},Map.prototype.reset=function(){this.$class.hide(),this.fields.$checkbox.prop("checked",!1),this.setProperties({latLng:"reset",rad:"reset",address:"reset"}),this.properties.hasLocation=!1,this.properties.isNew=!0},Map.prototype.updateFields=function(){""!=this.properties.latLng?(this.fields.$lat.val(this.properties.latLng.lat()),this.fields.$lng.val(this.properties.latLng.lng()),this.fields.$address.val(this.properties.address),this.properties.isNew&&this.fields.$display.val(this.properties.display_loc)):(this.fields.$lat.val(""),this.fields.$lng.val(""),this.fields.$address.val(""),this.fields.$display.val("")),""!=this.properties.rad?this.fields.$rad.val(toMiles(this.properties.rad)):this.fields.$rad.val(""),this.spinner.set(toMiles(this.properties.rad))},Map.prototype.setInitialLocation=function(){return this.properties.isNew?$.when(this.getUserLocation()).then(function(a){this.properties.latLng=new google.maps.LatLng(a.coords.latitude,a.coords.longitude),this.map.setCenter(this.properties.latLng),this.setProperties({latLng:this.properties.latLng,rad:toMeters(25)})}.bind(this),function(){this.properties.latLng=new google.maps.LatLng(41.877256,-87.620125),this.map.setCenter(this.properties.latLng),this.setProperties({latLng:this.properties.latLng,rad:toMeters(55)})}.bind(this)):this.properties.hasLocation?this.setProperties({latLng:this.properties.latLng,rad:toMeters(this.properties.rad),resize:!0}):this.reset(),this},Map.prototype.getUserLocation=function(){var a=$.Deferred();if(navigator.geolocation)navigator.geolocation.getCurrentPosition(a.resolve,a.reject);else{var b=Mustache.render($("#alertTemplate").html(),{message:"We tried to find your location automatically, but your browser doesn't support geolocation. Please set a location for your group."});$("#main").prepend(b);var c=$(".alert-new.hidden");c.slideDown("slow","easeOutExpo").removeClass("alert-new hidden"),alertTimeout(c),a.reject()}return a.promise()},Map.prototype.placeMarker=function(){return this.circle instanceof google.maps.Circle&&this.circle.setMap(null),this.circle=new google.maps.Circle({center:this.properties.latLng,radius:this.properties.rad,editable:!0,fillColor:"#008FC5",strokeColor:"#008FC5"}),this.circle.setMap(this.map),google.maps.event.addListener(this.circle,"radius_changed",function(a){this.setProperties({rad:this.circle.getRadius()}),ga("send","event","Map Action","Radius adjusted via map",this.circle.getRadius())}.bind(this)),google.maps.event.addListener(this.circle,"center_changed",function(a){this.setProperties({latLng:this.circle.getCenter()}),ga("send","event","Map Action","Radius dragged to new location",this.circle.getCenter())}.bind(this)),this.map.fitBounds(this.circle.getBounds()),this.setup&&google.maps.event.trigger(this.map,"resize"),this},Map.prototype.geocode=function(a){var b=$.Deferred();return geocoder.geocode(a,b.resolve),b.promise()},$(document).ready(function(){function a(){geocoder=new google.maps.Geocoder,map=new Map("#map_canvas")}$("#map_canvas").css("height","300px"),google.load("maps","3",{callback:a,other_params:"sensor=false"})});